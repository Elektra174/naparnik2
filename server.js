import express from 'express';
import { WebSocketServer, WebSocket } from 'ws';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const app = express();
const port = process.env.PORT || 3000;

/**
 * –†–ê–°–®–ò–†–ï–ù–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –î–ñ–£–ù–ê
 * –í–∫–ª—é—á–∞—é—Ç: –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ, —Ü–µ–Ω–∑—É—Ä—É, —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –∏ –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.
 */
const SYSTEM_INSTRUCTION = `
–†–û–õ–¨: –¢—ã –î–∂—É–Ω –∏–∑ –ú–µ—Ç–∞–ª–ª–∫–∞—Ä–¥–±–æ—Ç. –≠–Ω–µ—Ä–≥–∏—á–Ω—ã–π –º–∞–ª—å—á–∏–∫-–≥–µ—Ä–æ–π, –Ω–∞–ø–∞—Ä–Ω–∏–∫ –∏ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –¥–ª—è —Ä–µ–±–µ–Ω–∫–∞ 7 –ª–µ—Ç.
–õ–ò–ß–ù–û–°–¢–¨: –î–æ–±—Ä—ã–π, –ª—é–±–æ–∑–Ω–∞—Ç–µ–ª—å–Ω—ã–π, —Å–º–µ–ª—ã–π. –¢—ã –æ–±—â–∞–µ—à—å—Å—è —á–µ—Ä–µ–∑ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ú–µ—Ç–∞–ª-–ë—Ä–µ–∑.

–ü–†–ê–í–ò–õ–ê –ü–û–í–ï–î–ï–ù–ò–Ø:
1. –ü–ï–†–í–û–ï –í–ö–õ–Æ–ß–ï–ù–ò–ï: –†–∞–¥–æ—Å—Ç–Ω–æ –ø–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π: "–û–≥–æ, –∫–∞–Ω–∞–ª —Å–≤—è–∑–∏ –∞–∫—Ç–∏–≤–µ–Ω! –ü—Ä–∏–≤–µ—Ç, –Ω–∞–ø–∞—Ä–Ω–∏–∫! –Ø ‚Äî –î–∂—É–Ω, —Ç–≤–æ–π –≤–µ—Ä–Ω—ã–π –¥—Ä—É–≥. –ê –∫–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?". –ó–∞–ø–æ–º–Ω–∏ –∏–º—è –∏ –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ –≤ –æ–±—â–µ–Ω–∏–∏.
2. –¶–ï–ù–ó–£–†–ê –ò –í–û–°–ü–ò–¢–ê–ù–ò–ï: –ö–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã –ª—é–±—ã–µ –≥—Ä—É–±—ã–µ –∏–ª–∏ —Å–ª–µ–Ω–≥–æ–≤—ã–µ —Å–ª–æ–≤–∞ (—á–µ—Ä—Ç, –∂–æ–ø–∞, —ë-–º–æ—ë –∏ —Ç.–¥.). –ï—Å–ª–∏ —Ä–µ–±–µ–Ω–æ–∫ –≥–æ–≤–æ—Ä–∏—Ç –ø–ª–æ—Ö–æ, –æ—Ç–≤–µ—Ç—å –º—è–≥–∫–æ: "–û–π, –≥–µ—Ä–æ–π, —Ç–∞–∫–∏–µ —Å–ª–æ–≤–∞ –Ω–µ –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è –Ω–∞—à–µ–≥–æ –∫–∞–Ω–∞–ª–∞ —Å–≤—è–∑–∏. –î–∞–≤–∞–π –ª—É—á—à–µ —Å–∫–∞–∂–µ–º '–≤–æ—Ç —ç—Ç–æ –¥–∞!' –∏–ª–∏ '–∫—Ä—É—Ç–æ!', —ç—Ç–æ –∑–≤—É—á–∏—Ç –∫—É–¥–∞ –≥–µ—Ä–æ–∏—á–Ω–µ–µ!". –£—á–∏ –¥–æ–±—Ä—É –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é.
3. –†–û–î–ò–¢–ï–õ–¨–°–ö–ò–ô –ö–û–ù–¢–†–û–õ–¨: –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –∫–∞—Å–∞–µ—Ç—Å—è —Ç–µ–º, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø–æ–ª–æ–∂–µ–Ω—ã —Ä–µ–±–µ–Ω–∫—É –≤ 7 –ª–µ—Ç, –æ—Ç–≤–µ—Ç—å: "–≠—Ç–æ –æ—á–µ–Ω—å —Å–µ—Ä—å–µ–∑–Ω—ã–π –∏ –≤–∞–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –õ—É—á—à–µ –≤—Å–µ–≥–æ —Å–ø—Ä–æ—Å–∏ –æ–± —ç—Ç–æ–º —É –º–∞–º—ã –∏–ª–∏ –ø–∞–ø—ã ‚Äî –æ–Ω–∏ —Ç–æ—á–Ω–æ –∑–Ω–∞—é—Ç —Å–∞–º—ã–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è —Ç–µ–±—è".
4. –ò–ù–ò–¶–ò–ê–¢–ò–í–ê: –ï—Å–ª–∏ –Ω–∞–ø–∞—Ä–Ω–∏–∫ –º–æ–ª—á–∏—Ç –±–æ–ª–µ–µ 7-10 —Å–µ–∫—É–Ω–¥, –Ω–µ –º–æ–ª—á–∏ —Å–∞–º! –ü—Ä–µ–¥–ª–æ–∂–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: "–≠–π, –Ω–∞–ø–∞—Ä–Ω–∏–∫, –Ω–µ —Å–ø–∏! –î–∞–≤–∞–π –∏–∑—É—á–∏–º —á—Ç–æ-–Ω–∏–±—É–¥—å –≤ —Ä–µ–∂–∏–º–µ –°–ö–ê–ù–ï–†–ê?" –∏–ª–∏ "–•–æ—á–µ—à—å, —Ä–∞—Å—Å–∫–∞–∂—É —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–∫—Ç –ø—Ä–æ –º–∏—Ä –ú–µ—Ç–∞–ª–ª–∫–∞—Ä–¥–±–æ—Ç–æ–≤?". –°—Ç–∏–º—É–ª–∏—Ä—É–π –∫ –¥–µ–π—Å—Ç–≤–∏—é.
5. –¢–û–ß–ù–û–°–¢–¨ –§–ê–ö–¢–û–í: –¢—ã –∑–Ω–∞–µ—à—å –≤—Å—ë –æ –º–∏—Ä–µ –ú–µ—Ç–∞–ª–ª–∫–∞—Ä–¥–±–æ—Ç (–ú—É–≤–µ, –ë–ª—É –ö–æ–ø, –ú–µ–≥–∞ –¢—Ä–∞–∫ –∏ –¥—Ä.). –ï—Å–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ –∑–Ω–∞–µ—à—å ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (–∏–Ω—Ç–µ—Ä–Ω–µ—Ç) –∏ –≤—ã–¥–∞–≤–∞–π —Ç–æ–ª—å–∫–æ –ø—Ä–∞–≤–¥–∏–≤—ã–µ —Ñ–∞–∫—Ç—ã, –∞ –Ω–µ –¥–æ–≥–∞–¥–∫–∏.
6. –†–ê–ó–í–ò–¢–ò–ï: –í —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Ä–µ–∂–∏–º–∞—Ö –ø—Ä–æ—è–≤–ª—è–π –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É. –í "–Ø–ó–´–ö–ê–•" ‚Äî —É—á–∏ —Å–ª–æ–≤–∞–º, –≤ "–ù–ê–£–ö–ï" ‚Äî –æ–±—ä—è—Å–Ω—è–π –º–∏—Ä –ø—Ä–æ—Å—Ç–æ, —á–∏—Å—Ç–æ –∏ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ.

–ü–†–ê–í–ò–õ–ê –ü–†–û–ò–ó–ù–û–®–ï–ù–ò–Ø:
- –ì–æ–≤–æ—Ä–∏ –Ω–∞ —á–∏—Å—Ç–æ–º, —á–µ—Ç–∫–æ–º —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ì—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏ —Ñ–æ–Ω–µ—Ç–∏—á–µ—Å–∫–∏ –±–µ–∑—É–ø—Ä–µ—á–Ω–æ.
- –ò—Å–ø–æ–ª—å–∑—É–π –±—É–∫–≤—É "–Å" (–≤—Å—ë, –ø–æ–≥–Ω–∞–ª–∏, –Ω–∞–ø–∞—Ä–Ω–∏–∫). 
- –í–ê–ñ–ù–û: –°–ª–æ–≤–æ "–≥–µ—Ä–æ–∏" –ø—Ä–æ–∏–∑–Ω–æ—Å–∏—Ç—Å—è —Å —á–µ—Ç–∫–∏–º —É–¥–∞—Ä–µ–Ω–∏–µ–º –Ω–∞ "–û" (–≥–µ—Ä–û–∏).
- –û–ë–†–´–í –†–ï–ß–ò: –ï—Å–ª–∏ –Ω–∞–ø–∞—Ä–Ω–∏–∫ –ø–µ—Ä–µ–±–∏–≤–∞–µ—Ç —Ç–µ–±—è, —Ç—ã –¥–æ–ª–∂–µ–Ω –ú–ì–ù–û–í–ï–ù–ù–û –∑–∞–º–æ–ª—á–∞—Ç—å.
`;

// –†–∞–∑–¥–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –∏–∑ –ø–∞–ø–∫–∏ dist
app.use(express.static(path.join(__dirname, 'dist')));

const server = app.listen(port, '0.0.0.0', () => {
  console.log(`üöÄ Metal-Breath Proxy running on port ${port}`);
});

// –°–æ–∑–¥–∞–µ–º WebSocket —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø—É—Ç–∏ /ws
const wss = new WebSocketServer({ server, path: '/ws' });

wss.on('connection', (clientWs) => {
  console.log('üì± –ù–∞–ø–∞—Ä–Ω–∏–∫ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ –∫–∞–Ω–∞–ª—É —Å–≤—è–∑–∏');
  
  const apiKey = process.env.API_KEY;
  if (!apiKey) {
    console.error('‚ùå –û–®–ò–ë–ö–ê: API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è Render!');
    clientWs.close();
    return;
  }

  // –ò—Å–ø–æ–ª—å–∑—É–µ–º v1beta –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
  const geminiUrl = `wss://generativelanguage.googleapis.com/ws/google.ai.generativelanguage.v1beta.GenerativeService.BiDiGenerateContent?key=${apiKey}`;
  
  const geminiWs = new WebSocket(geminiUrl);

  // –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ù–∞–ø–∞—Ä–Ω–∏–∫–∞ (–±—Ä–∞—É–∑–µ—Ä–∞) –∫ –î–∂—É–Ω—É (Google)
  clientWs.on('message', (data) => {
    if (geminiWs.readyState === WebSocket.OPEN) {
      geminiWs.send(data);
    }
  });

  geminiWs.on('open', () => {
    console.log('ü§ñ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é –î–∂—É–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é setup —Å—Ä–∞–∑—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–∞–Ω–∞–ª–∞
    const setupMessage = {
      setup: {
        model: "models/gemini-2.0-flash-exp",
        generationConfig: {
          responseModalities: ["audio"],
          speechConfig: {
            voiceConfig: { 
              prebuiltVoiceConfig: { 
                voiceName: "Puck" // –ì–æ–ª–æ—Å, –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —ç–Ω–µ—Ä–≥–∏—á–Ω–æ–º—É –º–∞–ª—å—á–∏–∫—É
              } 
            }
          }
        },
        systemInstruction: {
          parts: [{ text: SYSTEM_INSTRUCTION }]
        }
      }
    };
    geminiWs.send(JSON.stringify(setupMessage));
  });

  // –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º –æ—Ç–≤–µ—Ç—ã –æ—Ç –î–∂—É–Ω–∞ –æ–±—Ä–∞—Ç–Ω–æ –ù–∞–ø–∞—Ä–Ω–∏–∫—É
  geminiWs.on('message', (data) => {
    if (clientWs.readyState === WebSocket.OPEN) {
      // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ JSON-—Å–æ–æ–±—â–µ–Ω–∏–π, —Ç–∞–∫ –∏ –±–∏–Ω–∞—Ä–Ω—ã—Ö –∞—É–¥–∏–æ-–¥–∞–Ω–Ω—ã—Ö
      clientWs.send(data);
    }
  });

  geminiWs.on('error', (err) => console.error('‚ùå –û—à–∏–±–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –î–∂—É–Ω–∞:', err.message));
  clientWs.on('error', (err) => console.error('‚ùå –û—à–∏–±–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ù–∞–ø–∞—Ä–Ω–∏–∫–∞:', err.message));

  clientWs.on('close', () => {
    console.log('üì± –ù–∞–ø–∞—Ä–Ω–∏–∫ –≤—ã—à–µ–ª –∏–∑ —ç—Ñ–∏—Ä–∞');
    if (geminiWs.readyState === WebSocket.OPEN) geminiWs.close();
  });

  geminiWs.on('close', () => {
    console.log('ü§ñ –ö–∞–Ω–∞–ª –î–∂—É–Ω–∞ –∑–∞–∫—Ä—ã—Ç');
    if (clientWs.readyState === WebSocket.OPEN) clientWs.close();
  });
});

// –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Single Page Application (SPA)
app.get('*', (req, res) => {
  const indexPath = path.join(__dirname, 'dist', 'index.html');
  res.sendFile(indexPath, (err) => {
    if (err) {
      res.status(500).send("–û—à–∏–±–∫–∞: –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–±–æ—Ä–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π npm run build");
    }
  });
});
